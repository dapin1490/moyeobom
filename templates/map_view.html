<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="height=device-height, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Pretendard&display=swap" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/map_view.css') }}" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font.css') }}">
    <title>Document</title>
    <script>
        function stageClick() {
            const div = document.querySelector(".info_popup");
            // 현재 display 상태를 확인하고 변경
            if (div.style.display === "none" || div.style.display === "") {
                div.style.display = "block"; // div 보이기
            } else {
                div.style.display = "none"; // div 숨기기
            }
        }
        function alertClick() {
            const div = document.querySelector(".v659_1332");
            div.style.display = "none"; // div 숨기기
        }
    </script>
</head>

<body>
    <div class="total_canvas">
        <div id="map_image" class="map_image"></div>
        <div class="name"></div>
        <div class="foods" style="top: 371px; left: 343px;">
            <div id="food01" class="food" style="top: 0px; left: 0px;">
                <div class="food_mark"></div>
                <span class="mark_name" style="width: 42px;">푸드코트</span>
            </div>
        </div>
        <!-- my position mark -->
        <!-- <div class="human_position">
            <div class="position_mark">
                <div class="v659_1049" style="width: 18px; height: 18px; background: rgba(255, 255, 255, 1); opacity: 1; position: relative; top: 0px; left: 0px; border-radius: 50%; box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.25);"></div>
                <div class="v659_1050" style="width: 14px; height: 14px; background: rgba(255, 49, 98, 1); opacity: 1; position: absolute; top: 2px; left: 2px; border-radius: 50%;"></div>
            </div>
            <div class="name"></div>
        </div> -->
        <div class="event_zones">
            <div class="event_zone">
                <div class="event_mark"></div>
                <span class="mark_name" style="width: 91px;">티켓부스&이벤트존</span>
            </div>
        </div>
        <div class="info_popup"> <!-- info popup -->
            <div class="info_window"></div>
            <span class="info_text info_artist">nothing but theives</span>
            <span class="info_text info_performance_status">공연중</span>
            <span class="info_stage">MAY FOREST :</span>
            <span id="ratio-info-label" class="info_status">여유</span>
            <!-- new tab button -->
            <a href="/map_view_info" style="text-decoration: none;">
                <div class="more_info_btn">
                </div>
            </a>
            <!-- progress bar -->
            <div class="progress_bar">
                <div class="progress-container">
                    <div class="progress-text">0%</div>
                    <div id="ratio-output" class="progress-bar">
                        <div id="ratio-output-inner" class="progress-bar-inner">
                            <span id="ratio-output-label" class="progress-label">0%</span>
                        </div>
                    </div>
                    <div class="progress-text">100%</div>
                </div>
            </div>
        </div>
        <a href="/">
            <div class="gpsmark"></div>
        </a>
        <div id= "toilets" class="toilets">
            <div class="toilet" style="top: 352px; left: 25px;">
                <div class="toilet_mark"></div>
                <span class="mark_name" style="width: 32px;">화장실</span>
            </div>
            <div class="toilet" style="top: 0px; left: 223px;">
                <div class="toilet_mark"></div>
                <span class="mark_name" style="width: 32px;">화장실</span>
            </div>
            <div class="toilet" style="top: 100px; left: 299px;">
                <div class="toilet_mark"></div>
                <span class="mark_name" style="width: 32px;">화장실</span>
            </div>
            <div class="toilet" style="top: 61px; left: 0px;">
                <div class="toilet_mark"></div>
                <span class="mark_name" style="width: 32px;">화장실</span>
            </div>
            <div class="toilet" style="top: 382px; left: 140px;">
                <div class="toilet_mark"></div>
                <span class="mark_name" style="width: 32px;">화장실</span>
            </div>
            <div class="toilet" style="top: 322px; left: 222px;">
                <div class="toilet_mark"></div>
                <span class="mark_name" style="width: 32px;">화장실</span>
            </div>
            <div class="toilet" style="top: 226px; left: 85px;">
                <div class="toilet_mark"></div>
                <span class="mark_name" style="width: 32px;">화장실</span>
            </div>
        </div>
        <div id="stages" class="stages">
            <div onclick="stageClick()" class="v659_1172">
                <div id="status_mark_demo" class="status_mark" style="background: rgba(20, 209, 0, 1);"></div>
                <span class="v659_1173">MAY FOREST</span>
            </div>
            <div class="stage" style="width: 143px; top: 265px; left: 6px;">
                <div class="status_mark" style="background: rgba(255,99,130,1);"></div>
                <span class="stage_name" style="width: 109px;">SPRING GARDEN</span>
            </div>
            <div class="stage" style="width: 123px; top: 242px; left: 214px;">
                <div class="status_mark" style="background: rgba(255, 221, 0, 1);"></div>
                <span class="stage_name" style="width: 89px;">PINK AVENUE</span>
            </div>
            <div class="stage" style="width: 129px; top: 104px; left: 278px;">
                <div class="status_mark" style="background: rgba(255, 221, 0, 1);"></div>
                <span class="stage_name" style="width: 95px;">SPARKE DOME</span>
            </div>
            <div class="stage" style="width: 122px; top: 0px; left: 87px;">
                <div class="status_mark" style="background: rgba(255, 99, 130, 1);"></div>
                <span class="stage_name" style="width: 115px;">discovery park</span>
            </div>
            <div class="stage" style="width: 117px; top: 136px; left: 126px;">
                <div class="status_mark" style="background: rgba(20, 209, 0, 1);"></div>
                <span class="stage_name" style="width: 83px;">SJF VILLAGE</span>
            </div>
            <div class="stage" style="width: 114px; top: 99px; left: 0px;">
                <div class="status_mark" style="background: rgba(255, 221, 0, 1);"></div>
                <span class="stage_name" style="width: 80px;">BRIGHT LAB</span>
            </div>
        </div>
        <div class="v659_1332">
            <div class="v659_1331"></div>
            <div class="v659_1333"></div>
            <div class="v659_1334">
                <div class="v659_1335"></div>
                <span class="v659_1336">오늘 더 이상 보지 않기</span>
            </div>
            <span class="v659_1337">안내되는 혼잡도는 실제 현장 상황과
                차이가 있을 수 있습니다.
                이 점 유의하시어 공연 및 부가시설
                이용 부탁드립니다.</span>
            <div onclick="alertClick()" class="v659_1338" style="cursor: pointer">
                <span class="v659_1340">확인</span>
                <div class="v659_1341">
                    <div class="v659_1342"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- 진행바 데이터 불러오기 스크립트 -->
    <script>
        async function fetchRatioData() {
            const color_code = ["rgba(20, 209, 0, 1)", "rgba(255, 221, 0, 1)", "rgba(255, 99, 130, 1)"];
            const progressBarInner = document.getElementById('ratio-output-inner');
            const progressLabel = document.getElementById('ratio-output-label');
            const status_mark = document.getElementById('status_mark_demo');
            const ratio_info_label = document.getElementById('ratio-info-label');

            // 상태와 퍼센티지 매핑
            const statusMap = {
                '1': 33,   // 1/3
                '2': 66,   // 2/3
                '3': 100   // 전체
            };
            const statusWord = {
                33: '여유',
                66: '보통',
                100: '혼잡'
            };

            var percentage = 1;
            var scode = 1;

            try {
                const response = await fetch("/detection_data_feed");
                const data = await response.json();
                scode = data.ratio_code;
                console.log("status code: " + scode);

                if (data.error) {
                    percentage = 0;
                } else {
                    // 전달받은 상태에 따라 퍼센티지 계산
                    percentage = statusMap[scode] || 2; // 상태가 없으면 2%
                }
            } catch (error) {
                console.error("Error fetching ratio data:", error);
            }

            if (percentage > 66) {
                progressBarInner.style.backgroundColor = color_code[2];
                status_mark.style.background = color_code[2];
                ratio_info_label.style.color = color_code[2];
            } else if (percentage > 33) {
                progressBarInner.style.backgroundColor = color_code[1];
                status_mark.style.background = color_code[1];
                ratio_info_label.style.color = color_code[1];
            } else {
                progressBarInner.style.backgroundColor = color_code[0];
                status_mark.style.background = color_code[0];
                ratio_info_label.style.color = color_code[0];
            }

            // 프로그레스 바와 텍스트 업데이트
            progressBarInner.style.width = percentage + '%';
            progressLabel.textContent = statusWord[percentage];
            ratio_info_label.textContent = statusWord[percentage];
        }

        // 주기적으로 서버에서 텍스트 데이터 가져오기
        setInterval(fetchRatioData, 1000); // 1초마다 호출
    </script>
</body>

</html>